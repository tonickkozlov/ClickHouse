# Default compiler used by upstream can be found in `docker/packager/deb/Dockerfile`.

default-flavor: buster

build_deps: &build_deps
  # Release build requirements
  ? ccache
  # Common
  ? debhelper
  ? devscripts
  ? fakeroot
  ? git-core
  ? gperf
  ? libreadline-dev
  ? libtool
  ? ninja-build
  ? pkg-config
  ? tzdata
  ? cmake
  ? s4cmd
  ? wget

tests_deps: &tests_deps
  ? gdb
  # clickhouse-test requirements
  ? brotli
  ? bsdmainutils # hexdump
  ? bzip2
  ? expect
  ? golang
  ? lsof
  ? moreutils # for ts command
  ? netcat-openbsd
  ? procps
  ? expect
  ? python3
  ? python3-pip
  ? python3-lxml
  ? python3-requests
  ? python3-termcolor
  ? python3-pip
  ? qemu-user-static
  ? telnet
  ? tree
  ? zstd
  ? xz-utils
  ? wget
  ? psmisc
  ? pv
  # For testing CH's psql interface which we can't disable.
  ? postgresql-client


buster:
  # cfsetup build [--ccache] -f buster
  build:
    build_dir: /cfsetup_build/clickhouse
    builddeps:
      <<: *build_deps
    pre-cache-copy-paths:
      - cf-build/llvm_mirror.txt
    pre-cache:
      # LLVM
      - echo "deb [trusted=yes] mirror+file:/cfsetup_build/clickhouse/cf-build/llvm_mirror.txt llvm-toolchain-buster-12 main" >> /etc/apt/sources.list
      - apt-get update
      - apt-get install --yes --no-install-recommends clang-12 lld-12 llvm-12
    post-cache:
      - sudo chown -R $(id -u):$(id -g) ..
      # Configure this build
      - export DEB_CC=clang-12
      - export DEB_CXX=clang++-12
      # Action
      - ./cf-build/release.sh
    artifacts:
      - '../*.deb'

  # cfsetup build [--ccache] -f buster -yt build_asan
  build_asan:
    build_dir: /cfsetup_build/clickhouse
    builddeps:
      <<: *build_deps
    pre-cache-copy-paths:
      - cf-build/llvm_mirror.txt
    pre-cache:
      # LLVM
      - echo "deb [trusted=yes] mirror+file:/cfsetup_build/clickhouse/cf-build/llvm_mirror.txt llvm-toolchain-buster-12 main" >> /etc/apt/sources.list
      - apt-get update
      - apt-get install --yes --no-install-recommends clang-12 lld-12 llvm-12
    post-cache:
      - sudo chown -R $(id -u):$(id -g) ..
      # Configure this build
      - export S3_CCACHE_KEY_SUFFIX=asan
      - export SANITIZER=address
      - export DEB_CC=clang-12
      - export DEB_CXX=clang++-12
      # Action
      - ./cf-build/release.sh
    artifacts:
      - '../*.deb'

  # cfsetup build [--ccache] -f buster -yt build_tsan
  build_tsan:
    build_dir: /cfsetup_build/clickhouse
    builddeps:
      <<: *build_deps
    pre-cache-copy-paths:
      - cf-build/llvm_mirror.txt
    pre-cache:
      # LLVM
      - echo "deb [trusted=yes] mirror+file:/cfsetup_build/clickhouse/cf-build/llvm_mirror.txt llvm-toolchain-buster-12 main" >> /etc/apt/sources.list
      - apt-get update
      - apt-get install --yes --no-install-recommends clang-12 lld-12 llvm-12
    post-cache:
      - sudo chown -R $(id -u):$(id -g) ..
      # Configure this build
      - export S3_CCACHE_KEY_SUFFIX=tsan
      - export SANITIZER=thread
      - export DEB_CC=clang-12
      - export DEB_CXX=clang++-12
      # Action
      - ./cf-build/release.sh
    artifacts:
      - '../*.deb'

  # cfsetup build [--ccache] -f buster -yt build_msan
  build_msan:
    build_dir: /cfsetup_build/clickhouse
    builddeps:
      <<: *build_deps
    pre-cache-copy-paths:
      - cf-build/llvm_mirror.txt
    pre-cache:
      # LLVM
      - echo "deb [trusted=yes] mirror+file:/cfsetup_build/clickhouse/cf-build/llvm_mirror.txt llvm-toolchain-buster-12 main" >> /etc/apt/sources.list
      - apt-get update
      - apt-get install --yes --no-install-recommends clang-12 lld-12 llvm-12
    post-cache:
      - sudo chown -R $(id -u):$(id -g) ..
      # Configure this build
      - export S3_CCACHE_KEY_SUFFIX=msan
      - export SANITIZER=memory
      - export DEB_CC=clang-12
      - export DEB_CXX=clang++-12
      # Action
      - ./cf-build/release.sh
    artifacts:
      - '../*.deb'

  # cfsetup build [--ccache] -f buster -yt build_ubsan
  build_ubsan:
    build_dir: /cfsetup_build/clickhouse
    builddeps:
      <<: *build_deps
    pre-cache-copy-paths:
      - cf-build/llvm_mirror.txt
    pre-cache:
      # LLVM
      - echo "deb [trusted=yes] mirror+file:/cfsetup_build/clickhouse/cf-build/llvm_mirror.txt llvm-toolchain-buster-12 main" >> /etc/apt/sources.list
      - apt-get update
      - apt-get install --yes --no-install-recommends clang-12 lld-12 llvm-12
    post-cache:
      - sudo chown -R $(id -u):$(id -g) ..
      # Configure this build
      - export S3_CCACHE_KEY_SUFFIX=ubsan
      - export SANITIZER=undefined
      - export DEB_CC=clang-12
      - export DEB_CXX=clang++-12
      # Action
      - ./cf-build/release.sh
    artifacts:
      - '../*.deb'

  # cfsetup build -f buster -yt tests_stateless
  tests_stateless:
    build_dir: /cfsetup_build/clickhouse
    nosubmodule: true
    cap_add:
      - SYS_PTRACE # LeakSanitizer (part of asan), gdb
    builddeps:
      <<: *tests_deps
    pre-cache-copy-paths:
      - cf-build/llvm_mirror.txt
    pre-cache:
      # Additional test dependencies.
      # Newer version of pandas require python3-dev, is rebuilt on each run and takes ages.
      - pip3 install numpy==1.21.3 scipy==1.7.1 pandas==1.2 Jinja2
      # LLVM; want symbolizers for crashes
      - echo "deb [trusted=yes] mirror+file:/cfsetup_build/clickhouse/cf-build/llvm_mirror.txt llvm-toolchain-buster-12 main" >> /etc/apt/sources.list
      - apt-get update
      - apt-get install --yes --no-install-recommends llvm-12
    post-cache:
      # Action
      - sudo -E ./cf-build/tests/stateless.sh

  # cfsetup build -f buster -yt fasttest
  fasttest:
    build_dir: /cfsetup_build/clickhouse
    cap_add:
      - SYS_PTRACE # gdb
    builddeps:
      <<: *build_deps
      <<: *tests_deps
    pre-cache-copy-paths:
      - cf-build/llvm_mirror.txt
    pre-cache:
      # Additional test dependencies.
      # Newer version of pandas require python3-dev, is rebuilt on each run and takes ages.
      - pip3 install numpy==1.21.3 scipy==1.7.1 pandas==1.2 Jinja2
      # LLVM
      - echo "deb [trusted=yes] mirror+file:/cfsetup_build/clickhouse/cf-build/llvm_mirror.txt llvm-toolchain-buster-12 main" >> /etc/apt/sources.list
      - apt-get update
      - apt-get install --yes --no-install-recommends clang-12 lld-12 llvm-12
    post-cache:
      - export LLVM_VERSION=12
      # Prep
      - sudo mkdir -p /var/lib/clickhouse /var/log/clickhouse-server
      - sudo chown -R $(id -u):$(id -g) /var/lib/clickhouse /var/log/clickhouse-server
      # Action
      - ./cf-build/fasttest.sh
    artifacts:
      - '/cfsetup_build/clickhouse/build_fasttest/out/*'

  # cfsetup build -f buster -yt dib-apt
  dib-apt:
    build_dir: /cfsetup_build/clickhouse
    post-cache:
      - ./cf-build/docker/gen-dib.sh apt

  # cfsetup build -f buster -yt dib-local
  dib-local:
    build_dir: /cfsetup_build/clickhouse
    post-cache:
      - ./cf-build/docker/gen-dib.sh local

# cfsetup compose -s tests_integration up
tests_integration:
  compose:
    environment-whitelist:
      - SSH_AUTH_SOCK
      - CI
      - CLOUDFLARE_DOCKER_REGISTRY_HOST
      # Do not run tests but hang.
      # Use `docker exec` to interact with the container.
      - TESTS_TO_RUN
      - PYTEST_EXTRA_ARGS
      - WAIT_DONT_RUN
    up-args:
      - --build
      - --force-recreate
      - --renew-anon-volumes
      - --exit-code-from
      - runner
    files:
      - ./cf-build/tests/integration/runner/docker-compose.yaml


stretch:
  build:
    post-cache:
      # do nothing
      - exit 0
